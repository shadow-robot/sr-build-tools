# Copyright 2022 Shadow Robot Company Ltd.
#
# This program is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the Free
# Software Foundation version 2 of the License.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
# more details.
#
# You should have received a copy of the GNU General Public License along
# with this program. If not, see <http://www.gnu.org/licenses/>.

---
# Playbook for workspace creation

- name: Create workspace {{ros_workspace}}
  file: state=directory path={{ros_workspace}}/src

- name: ROS1
  block:
    - name: catkin_init_workspace
      shell: bash -c "source /opt/ros/{{ros_release}}/setup.bash && catkin_init_workspace"
        chdir={{ros_workspace}}/src
        creates={{ros_workspace}}/src/CMakeLists.txt

    - name: Init workspace
      command: wstool init .
        chdir={{ros_workspace}}/src
        creates={{ros_workspace}}/src/.rosinstall

    - name: Update dependencies
      shell: bash -c "rosdep update -y"
             chdir={{ros_workspace}}

    - git:
        repo: 'https://github.com/ros/roslint.git'
        dest: /home/user/workspace/src/roslint
        version: python3-support
    
    - name: Updating roslint with python3 support
      command: bash -c "source /opt/ros/{{ros_release}}/setup.bash && catkin_make_isolated --install --pkg roslint --install-space $install_space /opt/ros/{{ros_release}}"
      args:
        chdir: "/home/user/workspace/"
      become: yes
      become_method: sudo
  when:
    - ros_release != 'rolling' 
    - ros_release != 'humble'

- name: ROS2
  block:
    - name: Colcon build workspace
      shell: bash -c "source /opt/ros/{{ros_release}}/setup.bash && colcon build"
        chdir={{ros_workspace}}

    - name: Init workspace
      command: wstool init .
        chdir={{ros_workspace}}/src
        creates={{ros_workspace}}/src/.rosinstall

    - name: Update dependencies
      shell: bash -c "rosdep update -y"
             chdir={{ros_workspace}}

    - git:
        repo: 'https://github.com/ros/roslint.git'
        dest: /home/user/workspace/src/roslint
        version: python3-support
    
 #   - name: Updating roslint with python3 support
 #     command: bash -c "source /opt/ros/{{ros_release}}/setup.bash && catkin_make_isolated --install --pkg roslint --install-space $install_space /opt/ros/{{ros_release}}"
 #     args:
 #       chdir: "/home/user/workspace/"
 #     become: yes
 #     become_method: sudo
  when:
    - ros_release == 'rolling' 
    - ros_release == 'humble'
