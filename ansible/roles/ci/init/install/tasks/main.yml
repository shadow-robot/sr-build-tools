# Copyright 2022 Shadow Robot Company Ltd.
#
# This program is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the Free
# Software Foundation version 2 of the License.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
# more details.
#
# You should have received a copy of the GNU General Public License along
# with this program. If not, see <http://www.gnu.org/licenses/>.

---
# Playbook for additional component installations

- name: Install more packages
  apt: 
    name: ['python3-wstool', 'python3-rosdep','python3-pip','cobertura','python3-bloom','fakeroot','libxml2-utils','libyubikey-dev','libykpers-1-dev']
  become: yes
  become_method: sudo
  become_user: root

- name: Create shadow_tools folder
  file:
    path: "{{ansible_env.HOME}}/.shadow_tools"
    state: directory
    mode: '0755'
  become: yes

- name: Change ownership of shadow_tools folder
  ansible.builtin.file:
    path: "{{ansible_env.HOME}}/.shadow_tools"
    state: directory
    owner: user
    group: user
  become: yes

- name: Copy EEpromtool
  get_url:
    url: https://github.com/shadow-robot/sr-build-tools/raw/master/bin/eepromtool
    dest : "{{ansible_env.HOME}}/.shadow_tools/eepromtool"
    mode: u+rwx
  become: yes

- name: Change EEpromtool ownership and group
  file:
    path: "{{ansible_env.HOME}}/.shadow_tools/eepromtool"
    owner: user
    group: user
  become: yes

- name: Write note about EEpromtool
  copy:
    dest: "{{ansible_env.HOME}}/.shadow_tools/eepromtool_readme"
    content: |
        Please Note that this tool should only be used by Shadow Support Staff and could lead to issues if used incorrectly.

- name: Install ros1 packages
  apt: 
    name: ['ros-{{ros_release}}-cmake-modules']
  become: yes
  become_method: sudo
  become_user: root
  when: 
    - ros_release != 'rolling' 
    - ros_release != 'humble'

- name: Install PIP modules
  pip: 
    name: ['catkin_pkg','empy','coverage','catkin-lint','pylint']
    extra_args: '--upgrade'
    executable: pip3
  become: yes
  become_method: sudo
  become_user: root
  when: 
    - ros_release == 'rolling' 
    - ros_release == 'humble'

- name: Install PIP modules
  pip: 
    name: ['catkin_pkg','empy==3.3.2','coverage','catkin-lint','pylint==2.10.2']
    extra_args: '--upgrade'
    executable: pip3
  become: yes
  become_method: sudo
  become_user: root
  when: 
    - ros_release != 'rolling' 
    - ros_release != 'humble'

- name: Update users bashrc to point to the ROS installation
  lineinfile: dest={{ansible_env.HOME}}/.bashrc
              line="source /opt/ros/{{ros_release}}/setup.bash"
              regexp='^source.*/setup\.bash'
              insertafter=EOF
              backup=yes
