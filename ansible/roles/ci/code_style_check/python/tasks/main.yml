---
# Playbook for Python code style check

- name: Get list of all Python files
  script: "../../common_resources/files/files_by_extension.py \
    -p {{repo_sources_path}} -ft python"
  register: python_files

- name: Set variable to workaround ansible type evaluation issue
  set_fact:
    python_files_results: "{{python_files.stdout_lines}}"

- name: Move pylintrc file
  copy:
    src: ../files/pylintrc
    dest: /tmp/pylintrc

- name: Execute roslint for every package and no extension files and write results in unit tests format
  shell: |
    source /opt/ros/{{ros_release}}/setup.bash && rosrun roslint test_wrapper \
    {{ros_workspace}}/build/test_results/{{item}}/roslint-python-ex-{{item}}.xml \
    'rosrun roslint pycodestyle --max-line-length=120 {{item}}'
         
    source /opt/ros/{{ros_release}}/setup.bash && rosrun roslint test_wrapper \
    {{ros_workspace}}/build/test_results/{{item}}/roslint-python3-ex-{{item}}.xml \
    "{pylint -sn --rcfile=/tmp/pylintrc --msg-template='{abspath}:{line}:{column}:{msg_id}:{msg}' {{item}}} | sort --field-separator=':' -k 2,2n"
  args:
    executable: "/bin/bash"
  with_items: "{{python_files_results|default([])}}"
  ignore_errors: True
