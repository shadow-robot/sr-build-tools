# Copyright 2022 Shadow Robot Company Ltd.
#
# This program is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the Free
# Software Foundation version 2 of the License.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
# more details.
#
# You should have received a copy of the GNU General Public License along
# with this program. If not, see <http://www.gnu.org/licenses/>.

---
# Playbook for C++ code style check

- name: Get list of all c, cpp, h, hpp files
  script: "../../common_resources/files/files_by_extension.py \
    -p {{repo_sources_path}} -ft cpp"
  register: cpp_files

- name: Set variable to workaround ansible type evaluation issue
  set_fact:
    cpp_files_results: "{{cpp_files.stdout_lines}}"

- name: "Execute roslint for every package and write results in unit tests format.\
    In order to skip hpp files extension validation using stdin feed to checker."
  shell: 'source /opt/ros/{{ros_release}}/setup.bash && \
    rosrun roslint test_wrapper \
      {{ros_workspace}}/build/test_results/{{item}}/roslint-hpp-{{item}}.xml \
      "rosrun roslint cpplint --extensions=hpp,h,cpp,c --linelength=120 --filter=-runtime/references {{item}}" '
  args:
    executable: "/bin/bash"
  with_items: "{{cpp_files_results|default([])}}"
  ignore_errors: True
